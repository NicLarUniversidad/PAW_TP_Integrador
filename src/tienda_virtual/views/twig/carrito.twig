{% extends "parts/commons.twig" %}

{% block head %}
    <script src="https://sdk.mercadopago.com/js/v2"></script>
    <link rel="stylesheet" type="text/css" href="css/carrito.css" />
    <script src="/js/scripts/carrito.js" ></script>
    <script src="/js/scripts/botonMercadoPago.js" ></script>
    <script src="/js/constants/constantsMercadoPago.js" ></script>
{% endblock %}

{% block main %}
    <section>
        <img src="img/arrow_back-24px.svg"  class="flecha-back" id="flecha" onclick="history.back();">
        <h1>Carrito</h1>
        <a href="/carrito-cancelar" class="btn-cancelar">Cancelar compra</a>
        {% for publicacion in data.publicaciones %}
            <article class="productos" id="productos">
                <picture>
                    <img src="fotografia_producto.url" class="imgArticulo" alt="{{ publicacion.producto.nombre }}" >
                </picture>
                <h2>{{ publicacion.productos[0].nombre }}</h2>
                <p>Precio: {{ publicacion.precio_unidad }} {{ publicacion.moneda.nombre }}</p>
                <p>Cantidad: {{ publicacion.cantidad }}</p>
                <button class="button-delete" id="eliminar-{{ publicacion.id }}">Eliminar artículo</button>
            </article>

    {% for carrito in data.carrito %}
        <p>{{ carrito.precio_total}}</p>  <!--Mostrar la suma de los precios de los productos-->
    {% else %}
    {% endfor %}
    </section>
            
    {% else %}
        <span class="carritoVacio">Su carrito está vacio</span>
        
        <span class="seguirCompra">Para seguir comprando, navegue por las categorías en el sitio, o busque su producto.</span>
        <a href="/grupocategorias" class="inicio">Seguir comprando</a>
    {% endfor %}
    <p class="total">Total compra: {{ data.monto_total }}</p>
    <div class="btn-pagar">
        <div id="checkout-btn"></div>
    </div>

    <script>
        // Add SDK credentials
        // REPLACE WITH YOUR PUBLIC KEY AVAILABLE IN: https://developers.mercadopago.com/panel
        const mercadopago = new MercadoPago("TEST-26dbdae3-8029-4cee-9ceb-70fe8181cc95", {
            locale: locale // The most common are: 'pt-BR', 'es-AR' and 'en-US'
        });
        //button.init(mercadopago);

        fetch("/create_preference", {
            method: "POST",
            headers: {
            "Content-Type": "application/json",
            }
        })
            .then(function (response) {
                return response.json();
            })
            .then(async function (preference) {
                await createCheckoutButton(preference.id);
            });

        async function createCheckoutButton(preferenceId) {

            await mercadopago.bricks().create("wallet", "checkout-btn", {
                initialization: {
                    preferenceId: preferenceId,
                    redirectMode: "modal"
                }
            });
        }


    </script>
{% endblock %}


